version: '3.8'

# Windows Server Docker Compose Configuration
# Optimized for Windows Server 2019/2022 with Docker Desktop or Docker Engine

services:
  isic-mapper:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: code-mapper-app
    ports:
      - "8501:8501"  # Direct access for Windows development/testing
    volumes:
      # Windows path format for volumes
      - .\outputs:/app/outputs
      # Mount ISIC data files (ensure they exist in the project directory)
      - .\Localised ISIC.xlsx:/app/Localised ISIC.xlsx:ro
      - .\isco_index.xlsx:/app/isco_index.xlsx:ro
      # Mount fine-tuned model if available (update path if different)
      - .\isic_classifier_final_20250831_133536:/app/isic_classifier_final_20250831_133536:ro
      # Logs directory
      - .\logs:/app/logs
    environment:
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_MAX_UPLOAD_SIZE=200
      - STREAMLIT_SERVER_ENABLE_CORS=false
      - STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION=true
      # Python optimizations
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    # Windows-specific resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    networks:
      - code-mapper-network

  # Optional: Nginx reverse proxy for production
  nginx:
    image: nginx:1.25-alpine
    container_name: code-mapper-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Windows path format
      - .\nginx.conf:/etc/nginx/nginx.conf:ro
      - .\ssl:/etc/nginx/ssl:ro
      - .\logs\nginx:/var/log/nginx
    depends_on:
      - isic-mapper
    restart: unless-stopped
    networks:
      - code-mapper-network

# Network configuration
networks:
  code-mapper-network:
    driver: bridge

# Named volumes for Windows
volumes:
  code_mapper_outputs:
    driver: local
  code_mapper_logs:
    driver: local